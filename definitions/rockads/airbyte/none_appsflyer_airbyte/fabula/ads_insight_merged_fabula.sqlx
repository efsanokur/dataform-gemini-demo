config {
  type: "table",
  bigquery: {
    partitionBy: "report_date"
   },
  database: `${dataform.projectConfig.vars.rockadsProject}`,
  schema: "fabula_marketing_ds",
  name: "ads_insights_fabula_merged",
  tags: ["ads_insights_fabula"],
  description: "Combines fabula ad insights with Zotlo revenue (purchases & refunds) using full outer join by date, country, and campaign."
}

# w2w
SELECT
  from_date as report_date,
  'Fabula' as app_name,
  if(utm_source in ('fb','ig','th','msg'), 'facebook',utm_source) as media_source,
  utm_campaign as campaign,
  utm_content as adset,
  utm_term as ad,
  users_count,
  quizes_started,
  paywall_views,
  subscriptions,
  subscribers,
  total_revenue,
  total_refunded,
  total_profit,
  canceled_subscriptions,
  arpu,
  arppu,
  view_to_start_quiz,
  view_to_finish_quiz,
  start_to_finish_quiz,
  view_to_buy,
  NULL AS total_spend,
  NULL AS total_impressions,
  NULL AS total_click,
  NULL AS total_conversions,
  CAST(NULL AS NUMERIC) AS fb_event_count_mobile_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_mobile_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_omni_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_omni_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_add_to_cart,
  CAST(NULL AS NUMERIC) AS fb_event_count_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_complete_registration,
  CAST(NULL AS FLOAT64) AS fb_event_value_complete_registration,
  CAST(NULL AS NUMERIC) AS fb_event_count_initiate_checkout,
  CAST(NULL AS FLOAT64) AS fb_event_value_initiate_checkout,
  CAST(NULL AS NUMERIC) AS fb_event_count_omni_initiated_checkout,
  CAST(NULL AS FLOAT64) AS fb_event_value_omni_initiated_checkout,
  CAST(NULL AS NUMERIC) AS fb_event_count_add_payment_info,
  CAST(NULL AS FLOAT64) AS fb_event_value_add_payment_info,
  CAST(NULL AS NUMERIC) AS fb_event_count_fb_pixel_add_payment_info,
  CAST(NULL AS FLOAT64) AS fb_event_value_fb_pixel_add_payment_info,
  CAST(NULL AS NUMERIC) AS fb_event_count_fb_pixel_complete_registration,
  CAST(NULL AS FLOAT64) AS fb_event_value_fb_pixel_complete_registration,
  CAST(NULL AS NUMERIC) AS fb_event_count_fb_pixel_initiate_checkout,
  CAST(NULL AS FLOAT64) AS fb_event_value_fb_pixel_initiate_checkout,
  CAST(NULL AS NUMERIC) AS fb_event_count_fb_pixel_lead,
  CAST(NULL AS FLOAT64) AS fb_event_value_fb_pixel_lead,
  CAST(NULL AS NUMERIC) AS fb_event_count_web_app_in_store_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_web_app_in_store_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_web_in_store_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_web_in_store_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_onsite_web_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_onsite_web_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_onsite_web_app_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_onsite_web_app_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_messaging_conversation_started_7d,
  CAST(NULL AS FLOAT64) AS fb_event_value_messaging_conversation_started_7d,

  CAST(NULL AS STRING) AS thumbnail_url,
  CAST(NULL AS STRING) AS video_url
FROM
  `rockads-thirdparty.web2wave.web2wave_utm_report_20*`
WHERE
  project_id = 241

# FB
UNION ALL
SELECT
  ad_insight_date_start AS report_date,
  'Fabula' as app_name,
  'facebook' AS media_source,
  campaign_name as campaign,
  adset_name AS adset,
  ad_name as ad,
  NULL AS users_count,
  NULL AS quizes_started,
  NULL AS paywall_views,
  NULL AS subscriptions,
  NULL AS subscribers,
  NULL AS total_revenue,
  NULL AS total_refunded,
  NULL AS total_profit,
  NULL AS canceled_subscriptions,
  NULL AS arpu,
  NULL AS arppu,
  NULL AS view_to_start_quiz,
  NULL AS view_to_finish_quiz,
  NULL AS start_to_finish_quiz,
  NULL AS view_to_buy,

  SUM(total_spend) AS total_spend,
  SUM(total_impressions) AS total_impressions,
  SUM(total_clicks) AS total_click,
  CAST(NULL AS FLOAT64) AS total_conversions,
  SUM(action_count_fb_mobile_purchase) AS fb_event_count_mobile_purchase,
  SUM(action_value_total_fb_mobile_purchase) AS fb_event_value_mobile_purchase,
  SUM(action_count_omni_purchase) AS fb_event_count_omni_purchase,
  SUM(action_value_total_omni_purchase) AS fb_event_value_omni_purchase,
  SUM(action_count_add_to_cart) AS fb_event_count_add_to_cart,
  SUM(action_count_purchase) AS fb_event_count_purchase,
  SUM(action_value_total_purchase) AS fb_event_value_purchase,
  SUM(action_count_complete_registration) AS fb_event_count_complete_registration,
  SUM(action_value_total_complete_registration) AS fb_event_value_complete_registration,
  SUM(action_count_initiate_checkout) AS fb_event_count_initiate_checkout,
  SUM(action_value_total_initiate_checkout) AS fb_event_value_initiate_checkout,
  SUM(action_count_omni_initiated_checkout) AS fb_event_count_omni_initiated_checkout,
  SUM(action_value_total_omni_initiated_checkout) AS fb_event_value_omni_initiated_checkout,
  SUM(action_count_add_payment_info) AS fb_event_count_add_payment_info,
  SUM(action_value_total_add_payment_info) AS fb_event_value_add_payment_info,
  SUM(action_count_fb_pixel_add_payment_info) AS fb_event_count_fb_pixel_add_payment_info,
  SUM(action_value_total_fb_pixel_add_payment_info) AS fb_event_value_fb_pixel_add_payment_info,
  SUM(action_count_fb_pixel_complete_registration) AS fb_event_count_fb_pixel_complete_registration,
  SUM(action_value_total_fb_pixel_complete_registration) AS fb_event_value_fb_pixel_complete_registration,
  SUM(action_count_fb_pixel_initiate_checkout) AS fb_event_count_fb_pixel_initiate_checkout,
  SUM(action_value_total_fb_pixel_initiate_checkout) AS fb_event_value_fb_pixel_initiate_checkout,
  SUM(action_count_fb_pixel_lead) AS fb_event_count_fb_pixel_lead,
  SUM(action_value_total_fb_pixel_lead) AS fb_event_value_fb_pixel_lead,
  SUM(action_count_web_app_in_store_purchase) AS fb_event_count_web_app_in_store_purchase,
  SUM(action_value_total_web_app_in_store_purchase) AS fb_event_value_web_app_in_store_purchase,
  SUM(action_count_web_in_store_purchase) AS fb_event_count_web_in_store_purchase,
  SUM(action_value_total_web_in_store_purchase) AS fb_event_value_web_in_store_purchase,
  SUM(action_count_onsite_web_purchase) AS fb_event_count_onsite_web_purchase,
  SUM(action_value_total_onsite_web_purchase) AS fb_event_value_onsite_web_purchase,
  SUM(action_count_onsite_web_app_purchase) AS fb_event_count_onsite_web_app_purchase,
  SUM(action_value_total_onsite_web_app_purchase) AS fb_event_value_onsite_web_app_purchase,
  SUM(action_count_messaging_conversation_started_7d) AS fb_event_count_messaging_conversation_started_7d,
  SUM(action_value_total_messaging_conversation_started_7d) AS fb_event_value_messaging_conversation_started_7d,

  thumbnail_url,
  video_url,

FROM rockads-thirdparty.fb_airbyte_datamarts.ads_insights_by_country_merged_7311415715539931_fabula
GROUP BY adset_name, ad_name, campaign_name, ad_insight_date_start,thumbnail_url,
  video_url

# Google
UNION ALL
SELECT
  segments_date AS report_date,
  'Fabula' as app_name,
  'google' AS media_source,
  campaign_name as campaign,
  ad_group_name AS adset,
  NULL AS ad,
  NULL AS users_count,
  NULL AS quizes_started,
  NULL AS paywall_views,
  NULL AS subscriptions,
  NULL AS subscribers,
  NULL AS total_revenue,
  NULL AS total_refunded,
  NULL AS total_profit,
  NULL AS canceled_subscriptions,
  NULL AS arpu,
  NULL AS arppu,
  NULL AS view_to_start_quiz,
  NULL AS view_to_finish_quiz,
  NULL AS start_to_finish_quiz,
  NULL AS view_to_buy,
  SUM(total_cost) AS total_spend,
  SUM(total_impressions) AS total_impressions,
  SUM(total_clicks) AS total_click,
  SUM(conversions) AS total_conversions,
  CAST(NULL AS NUMERIC) AS fb_event_count_mobile_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_mobile_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_omni_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_omni_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_add_to_cart,
  CAST(NULL AS NUMERIC) AS fb_event_count_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_complete_registration,
  CAST(NULL AS FLOAT64) AS fb_event_value_complete_registration,
  CAST(NULL AS NUMERIC) AS fb_event_count_initiate_checkout,
  CAST(NULL AS FLOAT64) AS fb_event_value_initiate_checkout,
  CAST(NULL AS NUMERIC) AS fb_event_count_omni_initiated_checkout,
  CAST(NULL AS FLOAT64) AS fb_event_value_omni_initiated_checkout,
  CAST(NULL AS NUMERIC) AS fb_event_count_add_payment_info,
  CAST(NULL AS FLOAT64) AS fb_event_value_add_payment_info,
  CAST(NULL AS NUMERIC) AS fb_event_count_fb_pixel_add_payment_info,
  CAST(NULL AS FLOAT64) AS fb_event_value_fb_pixel_add_payment_info,
  CAST(NULL AS NUMERIC) AS fb_event_count_fb_pixel_complete_registration,
  CAST(NULL AS FLOAT64) AS fb_event_value_fb_pixel_complete_registration,
  CAST(NULL AS NUMERIC) AS fb_event_count_fb_pixel_initiate_checkout,
  CAST(NULL AS FLOAT64) AS fb_event_value_fb_pixel_initiate_checkout,
  CAST(NULL AS NUMERIC) AS fb_event_count_fb_pixel_lead,
  CAST(NULL AS FLOAT64) AS fb_event_value_fb_pixel_lead,
  CAST(NULL AS NUMERIC) AS fb_event_count_web_app_in_store_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_web_app_in_store_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_web_in_store_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_web_in_store_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_onsite_web_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_onsite_web_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_onsite_web_app_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_onsite_web_app_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_messaging_conversation_started_7d,
  CAST(NULL AS FLOAT64) AS fb_event_value_messaging_conversation_started_7d,
  CAST(NULL AS string)  AS thumbnail_url,
  CAST(NULL AS string) AS video_url,

FROM rockads-thirdparty.googleAds_dm.all_apps_geographic_view
WHERE customer_id = 3458336672
GROUP BY ad_group_name, campaign_name, segments_date,thumbnail_url,
  video_url

# Fabula
UNION ALL

SELECT
  stat_time_day AS report_date,
  'Fabula' as app_name,
  'tiktok' AS media_source,
  campaign_name as campaign,
  adgroup_name AS adset,
  ad_name AS ad,
  NULL AS users_count,
  NULL AS quizes_started,
  NULL AS paywall_views,
  NULL AS subscriptions,
  NULL AS subscribers,
  NULL AS total_revenue,
  NULL AS total_refunded,
  NULL AS total_profit,
  NULL AS canceled_subscriptions,
  NULL AS arpu,
  NULL AS arppu,
  NULL AS view_to_start_quiz,
  NULL AS view_to_finish_quiz,
  NULL AS start_to_finish_quiz,
  NULL AS view_to_buy,
  SUM(spend) AS total_spend,
  SUM(impressions) AS total_impressions,
  SUM(clicks) AS total_click,
  NULL AS total_conversions,
  CAST(NULL AS NUMERIC) AS fb_event_count_mobile_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_mobile_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_omni_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_omni_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_add_to_cart,
  CAST(NULL AS NUMERIC) AS fb_event_count_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_complete_registration,
  CAST(NULL AS FLOAT64) AS fb_event_value_complete_registration,
  CAST(NULL AS NUMERIC) AS fb_event_count_initiate_checkout,
  CAST(NULL AS FLOAT64) AS fb_event_value_initiate_checkout,
  CAST(NULL AS NUMERIC) AS fb_event_count_omni_initiated_checkout,
  CAST(NULL AS FLOAT64) AS fb_event_value_omni_initiated_checkout,
  CAST(NULL AS NUMERIC) AS fb_event_count_add_payment_info,
  CAST(NULL AS FLOAT64) AS fb_event_value_add_payment_info,
  CAST(NULL AS NUMERIC) AS fb_event_count_fb_pixel_add_payment_info,
  CAST(NULL AS FLOAT64) AS fb_event_value_fb_pixel_add_payment_info,
  CAST(NULL AS NUMERIC) AS fb_event_count_fb_pixel_complete_registration,
  CAST(NULL AS FLOAT64) AS fb_event_value_fb_pixel_complete_registration,
  CAST(NULL AS NUMERIC) AS fb_event_count_fb_pixel_initiate_checkout,
  CAST(NULL AS FLOAT64) AS fb_event_value_fb_pixel_initiate_checkout,
  CAST(NULL AS NUMERIC) AS fb_event_count_fb_pixel_lead,
  CAST(NULL AS FLOAT64) AS fb_event_value_fb_pixel_lead,
  CAST(NULL AS NUMERIC) AS fb_event_count_web_app_in_store_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_web_app_in_store_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_web_in_store_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_web_in_store_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_onsite_web_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_onsite_web_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_onsite_web_app_purchase,
  CAST(NULL AS FLOAT64) AS fb_event_value_onsite_web_app_purchase,
  CAST(NULL AS NUMERIC) AS fb_event_count_messaging_conversation_started_7d,
  CAST(NULL AS FLOAT64) AS fb_event_value_messaging_conversation_started_7d,
  video_thumbnail_url AS thumbnail_url,
  video_url AS video_url,

FROM rockads-thirdparty.tiktok_airbyte_datamarts.ads_audience_reports_by_country_merged_fabula
group by ALL

