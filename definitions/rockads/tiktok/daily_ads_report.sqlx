config {
    type: "incremental",
    database: `${dataform.projectConfig.vars.rockadsProject}`,
    name: "tiktok_ads_report_daily",
    schema: "tiktok_airbyte_datamarts",
    tags: ['tiktok_daily_datamarts']
}

SELECT
  DATE(stat_time_day) AS stat_time_day,
  base.ad_id,
  JSON_VALUE(metrics, '$.ad_name') AS ad_name,
  JSON_VALUE(metrics, '$.ad_text') AS ad_text,
  JSON_VALUE(metrics, '$.adgroup_id') AS adgroup_id,
  JSON_VALUE(metrics, '$.adgroup_name') AS adgroup_name,
  JSON_VALUE(metrics, '$.campaign_id') AS campaign_id,
  JSON_VALUE(metrics, '$.campaign_name') AS campaign_name,
  base.advertiser_id,
  dynamic_destination AS ad_dynamic_destination,
  ads.identity_type AS ad_identity_type,
  operation_status AS ad_operation_status,
  display_name AS ad_display_name,
  vertical_video_strategy AS ad_vertical_video_strategy,
  image_mode AS ad_image_mode,
  CONCAT("https://www.tiktok.com/player/v1/",tiktok_item_id,"?id=",tiktok_item_id) AS ad_video_url, 
  profile_image_url AS ad_profile_image_url, 
  CAST(JSON_VALUE(metrics, '$.app_install') AS FLOAT64) AS app_install,
  CAST(JSON_VALUE(metrics, '$.average_video_play') AS FLOAT64) AS average_video_play,
  CAST(JSON_VALUE(metrics, '$.average_video_play_per_user')AS FLOAT64) AS average_video_play_per_user,
  CAST(JSON_VALUE(metrics, '$.clicks')AS FLOAT64) AS clicks,
  CAST(JSON_VALUE(metrics, '$.comments')AS FLOAT64) AS comments,
  CAST(JSON_VALUE(metrics, '$.complete_payment')AS FLOAT64) AS complete_payment,
  CAST(JSON_VALUE(metrics, '$.conversion')AS FLOAT64) AS conversion,
  CAST(JSON_VALUE(metrics, '$.conversion_rate')AS FLOAT64) AS conversion_rate,
  CAST(JSON_VALUE(metrics, '$.cost_per_1000_reached')AS FLOAT64) AS cost_per_1000_reached,
  CAST(JSON_VALUE(metrics, '$.cost_per_conversion')AS FLOAT64) AS cost_per_conversion,
  CAST(JSON_VALUE(metrics, '$.cost_per_result')AS FLOAT64) AS cost_per_result,
  CAST(JSON_VALUE(metrics, '$.cpc')AS FLOAT64) AS cpc,
  CAST(JSON_VALUE(metrics, '$.cpm')AS FLOAT64) AS cpm,
  CAST(JSON_VALUE(metrics, '$.cta_conversion')AS FLOAT64) AS cta_conversion,
  CAST(JSON_VALUE(metrics, '$.cta_purchase')AS FLOAT64) AS cta_purchase,
  CAST(JSON_VALUE(metrics, '$.ctr')AS FLOAT64) AS ctr,
  JSON_VALUE(metrics, '$.dpa_target_audience_type') AS dpa_target_audience_type,
  CAST(JSON_VALUE(metrics, '$.follows')AS FLOAT64) AS follows,
  CAST(JSON_VALUE(metrics, '$.impressions')AS FLOAT64) AS impressions,
  CAST(JSON_VALUE(metrics, '$.likes')AS FLOAT64) AS likes,
  JSON_VALUE(metrics, '$.mobile_app_id') AS mobile_app_id,
  CAST(JSON_VALUE(metrics, '$.onsite_shopping')AS FLOAT64) AS onsite_shopping,
  JSON_VALUE(metrics, '$.placement_type') AS placement_type,
  CAST(JSON_VALUE(metrics, '$.profile_visits')AS FLOAT64) AS profile_visits,
  JSON_VALUE(metrics, '$.promotion_type') AS promotion_type,
  CAST(JSON_VALUE(metrics, '$.reach')AS FLOAT64) AS reach,
  CAST(JSON_VALUE(metrics, '$.real_time_app_install')AS FLOAT64) AS real_time_app_install,
  CAST(JSON_VALUE(metrics, '$.real_time_app_install_cost')AS FLOAT64) AS real_time_app_install_cost,
  CAST(JSON_VALUE(metrics, '$.real_time_conversion')AS FLOAT64) AS real_time_conversion,
  CAST(JSON_VALUE(metrics, '$.real_time_conversion_rate')AS FLOAT64) AS real_time_conversion_rate,
  CAST(JSON_VALUE(metrics, '$.real_time_cost_per_conversion')AS FLOAT64) AS real_time_cost_per_conversion,
  CAST(JSON_VALUE(metrics, '$.real_time_cost_per_result')AS FLOAT64) AS real_time_cost_per_result,
  CAST(JSON_VALUE(metrics, '$.real_time_result')AS FLOAT64) AS real_time_result,
  CAST(JSON_VALUE(metrics, '$.real_time_result_rate')AS FLOAT64) AS real_time_result_rate,
  CAST(JSON_VALUE(metrics, '$.result')AS FLOAT64) AS result,
  CAST(JSON_VALUE(metrics, '$.result_rate')AS FLOAT64) AS result_rate,
  CAST(JSON_VALUE(metrics, '$.shares')AS FLOAT64) AS shares,
  CAST(JSON_VALUE(metrics, '$.spend')AS FLOAT64) AS spend,
  CAST(JSON_VALUE(metrics, '$.total_complete_payment_rate')AS FLOAT64) AS total_complete_payment_rate,
  CAST(JSON_VALUE(metrics, '$.total_onsite_shopping_value')AS FLOAT64) AS total_onsite_shopping_value,
  CAST(JSON_VALUE(metrics, '$.total_pageview')AS FLOAT64) AS total_pageview,
  CAST(JSON_VALUE(metrics, '$.total_purchase_value')AS FLOAT64) AS total_purchase_value,
  JSON_VALUE(metrics, '$.tt_app_id') AS tt_app_id,
  JSON_VALUE(metrics, '$.tt_app_name') AS tt_app_name,
  CAST(JSON_VALUE(metrics, '$.value_per_complete_payment')AS FLOAT64) AS value_per_complete_payment,
  CAST(JSON_VALUE(metrics, '$.video_play_actions')AS FLOAT64) AS video_play_actions,
  CAST(JSON_VALUE(metrics, '$.video_views_p100')AS FLOAT64) AS video_views_p100,
  CAST(JSON_VALUE(metrics, '$.video_views_p25')AS FLOAT64) AS video_views_p25,
  CAST(JSON_VALUE(metrics, '$.video_views_p50') AS FLOAT64) AS video_views_p50,
  CAST(JSON_VALUE(metrics, '$.video_views_p75') AS FLOAT64) AS video_views_p75,
  CAST(JSON_VALUE(metrics, '$.video_watched_2s') AS FLOAT64) AS video_watched_2s,
  CAST(JSON_VALUE(metrics, '$.video_watched_6s') AS FLOAT64) AS video_watched_6s,
  CAST(JSON_VALUE(metrics, '$.vta_conversion') AS FLOAT64) AS vta_conversion,
  CAST(JSON_VALUE(metrics, '$.vta_purchase') AS FLOAT64) AS vta_purchase
FROM
  `${dataform.projectConfig.vars.rockadsProject}.tiktok_airbyte._6980313007985262593_ads_reports_daily` base
LEFT JOIN
  `${dataform.projectConfig.vars.rockadsProject}.tiktok_airbyte._6980313007985262593_ads` ads
ON
  base.ad_id = ads.ad_id
WHERE stat_time_day = CURRENT_DATE() -1
